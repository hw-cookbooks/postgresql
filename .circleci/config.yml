version: 2.1
workflows:
  build:
    jobs:
      - sous-chefs/danger:
          context: Danger
          name: Danger
      - sous-chefs/lint:
          name: Lint

orbs:
  sous-chefs:
    executors:
      ruby:
        docker: [ image: circleci/ruby ]
      chef:
        machine: true
    jobs:
      danger:
        executor: ruby
        steps:
          - checkout
          - run:
              name: Install Danger
              command: gem install danger
          - run:
              name: Run Danger
              command: danger
      lint:
        executor: chef
        parameters:
          channel:
            description: ChefDK channel stable or current
            type: string
            default: current
        steps:
          - checkout
          - run:
              name: Install Chef
              command: curl -L https://omnitruck.chef.io/install.sh | sudo bash -s -- -c <<parameters.channel>> -P chefdk
          - run:
              name: Unit Test
              command: chef exec delivery local all
